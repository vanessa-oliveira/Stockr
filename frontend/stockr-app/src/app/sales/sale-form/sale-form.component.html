<p-toast></p-toast>
<p-dialog
  [header]="sale ? 'Editar Venda' : 'Adicionar Venda'"
  [modal]="true"
  [visible]="visible"
  (visibleChange)="onVisibilityChange($event)"
  [style]="{ width: '50rem' }"
  class="sale-dialog">
  <form [formGroup]="saleForm">
    <span class="dialog-description">{{ sale ? 'Edite os dados da venda.' : 'Adicione uma nova venda.' }}</span>

    <div class="form-row">
      <div class="form-field">
        <label for="customerId">Cliente
        </label>
        <p-select
          id="customerId"
          formControlName="customerId"
          [options]="customers"
          optionLabel="name"
          optionValue="id"
          placeholder="Selecione um cliente">
        </p-select>
      </div>

      <div class="form-field">
        <label for="saleStatus">Status *</label>
        <p-select
          id="saleStatus"
          formControlName="saleStatus"
          [options]="saleStatuses"
          optionLabel="label"
          optionValue="value"
          placeholder="Selecione o status">
        </p-select>
      </div>

      <div class="form-field">
        <label for="saleDate">Data *</label>
        <p-datepicker
          id="saleDate"
          formControlName="saleDate"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          appendTo="body"
          placeholder="Selecione a data">
        </p-datepicker>
      </div>
    </div>

    <div class="items-section">
      <div class="items-header">
        <label>Itens da Venda *</label>
        <p-button
          label="Adicionar Item"
          icon="pi pi-plus"
          severity="secondary"
          size="small"
          (click)="addSaleItem()"
          type="button" />
      </div>

      <div formArrayName="saleItems" class="items-list">
        @for (item of saleItems.controls; track $index) {
          <div [formGroupName]="$index" class="item-row">
            <div class="form-field flex-2">
              <label [for]="'product-' + $index">Produto</label>
              <p-select
                [id]="'product-' + $index"
                formControlName="productId"
                [options]="products"
                optionLabel="name"
                optionValue="id"
                placeholder="Selecione um produto"
                (onChange)="onProductChange($index)">
              </p-select>
            </div>

            <div class="form-field flex-1">
              <label [for]="'quantity-' + $index">Quantidade</label>
              <p-inputNumber
                [id]="'quantity-' + $index"
                formControlName="quantity"
                [min]="1"
                [showButtons]="true"
                (onInput)="onValueChange()">
              </p-inputNumber>
            </div>

            <div class="form-field flex-1">
              <label [for]="'unitPrice-' + $index">Preço Unit.</label>
              <p-inputNumber
                [id]="'unitPrice-' + $index"
                formControlName="unitPrice"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                (onInput)="onValueChange()">
              </p-inputNumber>
            </div>

            <div class="form-field flex-1">
              <label>Subtotal</label>
              <span class="subtotal">{{ getSubtotal($index) | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
            </div>

            <div class="item-actions">
              <p-button
                icon="pi pi-trash"
                severity="danger"
                [text]="true"
                size="small"
                (click)="removeSaleItem($index)"
                type="button" />
            </div>
          </div>
        }

        @if (saleItems.length === 0) {
          <div class="no-items">
            Nenhum item adicionado. Clique em "Adicionar Item" para começar.
          </div>
        }
      </div>

      <div class="total-section">
        <span class="total-label">Total:</span>
        <span class="total-value">{{ totalAmount | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
      </div>
    </div>

    <div class="dialog-actions">
      <p-button label="Cancelar" severity="secondary" (click)="closeDialog()" />
      <p-button class="save-button" label="Salvar" [disabled]="saleForm.invalid || isLoading" [loading]="isLoading" (click)="onSubmit()" />
    </div>
  </form>
</p-dialog>
