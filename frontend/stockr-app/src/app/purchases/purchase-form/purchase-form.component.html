<p-toast></p-toast>
<p-dialog
  [header]="purchase ? 'Editar Compra' : 'Adicionar Compra'"
  [modal]="true"
  [visible]="visible"
  (visibleChange)="onVisibilityChange($event)"
  [style]="{ width: '50rem' }"
  class="purchase-dialog">
  <form [formGroup]="purchaseForm">
    <span class="dialog-description">{{ purchase ? 'Edite os dados da compra.' : 'Adicione uma nova compra.' }}</span>

    <div class="form-row">
      <div class="form-field">
        <label for="supplierId">Fornecedor *</label>
        @if(suppliers.length > 0) {
          <p-select
            id="supplierId"
            formControlName="supplierId"
            [options]="suppliers"
            optionLabel="name"
            optionValue="id"
            placeholder="Selecione um fornecedor">
          </p-select>
        } @else {
          <p-select
            id="supplierId"
            formControlName="supplierId"
            [options]="[]"
            placeholder="Carregando fornecedores...">
          </p-select>
        }
      </div>

      <div class="form-field">
        <label for="invoiceNumber">Nota Fiscal *</label>
        <input pInputText id="invoiceNumber" formControlName="invoiceNumber" autocomplete="off" />
      </div>

      <div class="form-field">
        <label for="purchaseDate">Data *</label>
        <p-datepicker
          id="purchaseDate"
          formControlName="purchaseDate"
          dateFormat="dd/mm/yy"
          [showIcon]="true"
          appendTo="body"
          placeholder="Selecione a data">
        </p-datepicker>
      </div>
    </div>

    <div class="form-field full-width">
      <label for="notes">Observações</label>
      <textarea pTextarea id="notes" formControlName="notes" rows="3" style="resize: none"></textarea>
    </div>

    <div class="items-section">
      <div class="items-header">
        <label>Itens da Compra *</label>
        <p-button
          label="Adicionar Item"
          icon="pi pi-plus"
          severity="secondary"
          size="small"
          (click)="addPurchaseItem()"
          type="button" />
      </div>

      <div formArrayName="purchaseItems" class="items-list">
        @for (item of purchaseItems.controls; track $index) {
          <div [formGroupName]="$index" class="item-row">
            <div class="form-field flex-2">
              <label [for]="'product-' + $index">Produto</label>
              @if(products.length > 0) {
                <p-select
                  [id]="'product-' + $index"
                  formControlName="productId"
                  [options]="products"
                  optionLabel="name"
                  optionValue="id"
                  placeholder="Selecione um produto"
                  (onChange)="onProductChange($index)">
                </p-select>
              } @else {
                <p-select
                  [id]="'product-' + $index"
                  formControlName="productId"
                  [options]="[]"
                  placeholder="Carregando produtos...">
                </p-select>
              }
            </div>

            <div class="form-field flex-1">
              <label [for]="'quantity-' + $index">Quantidade</label>
              <p-inputNumber
                [id]="'quantity-' + $index"
                formControlName="quantity"
                [min]="1"
                [showButtons]="true"
                (onInput)="onValueChange()">
              </p-inputNumber>
            </div>

            <div class="form-field flex-1">
              <label [for]="'unitPrice-' + $index">Preço Unit.</label>
              <p-inputNumber
                [id]="'unitPrice-' + $index"
                formControlName="unitPrice"
                mode="currency"
                currency="BRL"
                locale="pt-BR"
                (onInput)="onValueChange()">
              </p-inputNumber>
            </div>

            <div class="form-field flex-1">
              <label>Subtotal</label>
              <span class="subtotal">{{ getSubtotal($index) | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
            </div>

            <div class="item-actions">
              <p-button
                icon="pi pi-trash"
                severity="danger"
                [text]="true"
                size="small"
                (click)="removePurchaseItem($index)"
                type="button" />
            </div>
          </div>
        }

        @if (purchaseItems.length === 0) {
          <div class="no-items">
            Nenhum item adicionado. Clique em "Adicionar Item" para começar.
          </div>
        }
      </div>

      <div class="total-section">
        <span class="total-label">Total:</span>
        <span class="total-value">{{ totalAmount | currency:'BRL':'symbol':'1.2-2':'pt-BR' }}</span>
      </div>
    </div>

    <div class="dialog-actions">
      <p-button label="Cancelar" severity="secondary" (click)="closeDialog()" />
      <p-button label="Salvar" [disabled]="purchaseForm.invalid || isLoading" [loading]="isLoading" (click)="onSubmit()" />
    </div>
  </form>
</p-dialog>
